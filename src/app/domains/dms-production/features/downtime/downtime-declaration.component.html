<div class="declaration-workflow-container">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Downtime Declaration</h1>
            <p class="page-subtitle">Notify maintenance technicians about production downtimes</p>
        </div>
        <div class="header-actions">
            <p-button
                icon="pi pi-refresh"
                [outlined]="true"
                [loading]="isLoading"
                (click)="loadDeclarations()"
                pTooltip="Refresh">
            </p-button>
            <p-button
                [icon]="autoRefreshEnabled ? 'pi pi-pause' : 'pi pi-play'"
                [outlined]="true"
                [severity]="autoRefreshEnabled ? 'success' : 'secondary'"
                (click)="toggleAutoRefresh()"
                [pTooltip]="autoRefreshEnabled ? 'Disable auto-refresh' : 'Enable auto-refresh'">
            </p-button>
            <p-button
                label="New Declaration"
                icon="pi pi-plus"
                (click)="openNewDeclarationDialog()">
            </p-button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-grid">
        <p-card styleClass="summary-card">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--yellow-100);">
                    <i class="pi pi-exclamation-triangle" style="color: var(--yellow-600);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Pending</span>
                    <span class="summary-value">{{ pendingDeclarations.length }}</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--blue-100);">
                    <i class="pi pi-clock" style="color: var(--blue-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">In Progress</span>
                    <span class="summary-value">{{ getCountByStatus('in_progress') }}</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--green-100);">
                    <i class="pi pi-check-circle" style="color: var(--green-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Resolved Today</span>
                    <span class="summary-value">{{ getCountByStatus('resolved') }}</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card" [ngClass]="{'card-danger': pendingDeclarations.length > 0}">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--red-100);">
                    <i class="pi pi-bolt" style="color: var(--red-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Critical</span>
                    <span class="summary-value">{{ getCriticalCount() }}</span>
                </div>
            </div>
        </p-card>
    </div>

    <!-- Pending Declarations Alert -->
    <p-card *ngIf="pendingDeclarations.length > 0" styleClass="alert-card">
        <div class="alert-content">
            <div class="alert-icon">
                <i class="pi pi-bell"></i>
            </div>
            <div class="alert-info">
                <span class="alert-title">{{ pendingDeclarations.length }} Pending Declaration(s)</span>
                <span class="alert-subtitle">Awaiting acknowledgment from maintenance team</span>
            </div>
            <div class="alert-actions">
                <p-button
                    label="View Pending"
                    icon="pi pi-eye"
                    severity="warn"
                    size="small"
                    (click)="statusFilter = 'declared'; onFilterChange()">
                </p-button>
            </div>
        </div>
    </p-card>

    <!-- Filters Card -->
    <p-card styleClass="filter-card">
        <ng-template pTemplate="header">
            <div class="card-header">
                <div class="header-left">
                    <i class="pi pi-filter header-icon"></i>
                    <h2 class="card-title">Filters</h2>
                </div>
                <div class="header-actions">
                    <p-button
                        *ngIf="statusFilter || lineFilter"
                        label="Clear Filters"
                        icon="pi pi-times"
                        [text]="true"
                        size="small"
                        (click)="statusFilter = null; lineFilter = null; onFilterChange()">
                    </p-button>
                </div>
            </div>
        </ng-template>

        <div class="filter-grid">
            <div class="form-field">
                <label for="statusFilter"><i class="pi pi-tag"></i> Status</label>
                <p-select
                    id="statusFilter"
                    [options]="statusOptions"
                    [(ngModel)]="statusFilter"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="All Statuses"
                    [showClear]="true"
                    (onChange)="onFilterChange()"
                    [style]="{ width: '100%' }">
                </p-select>
            </div>
            <div class="form-field">
                <label for="lineFilter"><i class="pi pi-sitemap"></i> Production Line</label>
                <p-select
                    id="lineFilter"
                    [options]="productionLines"
                    [(ngModel)]="lineFilter"
                    optionLabel="name"
                    optionValue="id"
                    placeholder="All Lines"
                    [showClear]="true"
                    (onChange)="onFilterChange()"
                    [style]="{ width: '100%' }">
                </p-select>
            </div>
        </div>
    </p-card>

    <!-- Declarations Table -->
    <p-card styleClass="declarations-card">
        <ng-template pTemplate="header">
            <div class="card-header">
                <div class="header-left">
                    <i class="pi pi-list header-icon"></i>
                    <h2 class="card-title">Declarations</h2>
                    <p-tag [value]="declarations.length + ' Total'" severity="info"></p-tag>
                </div>
            </div>
        </ng-template>

        <p-table
            [value]="declarations"
            [loading]="isLoading"
            [rowHover]="true"
            [paginator]="true"
            [rows]="10"
            [rowsPerPageOptions]="[10, 25, 50]"
            [globalFilterFields]="['ticket_number', 'reason', 'workstation_name', 'production_line_name']"
            styleClass="declarations-table">

            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 120px">Ticket</th>
                    <th>Location</th>
                    <th style="width: 110px">Type</th>
                    <th style="width: 100px">Impact</th>
                    <th>Reason</th>
                    <th style="width: 110px">Status</th>
                    <th style="width: 160px">Declared</th>
                    <th style="width: 140px">Technician</th>
                    <th style="width: 180px">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-declaration>
                <tr [ngClass]="{
                    'row-pending': declaration.status === 'declared',
                    'row-in-progress': declaration.status === 'in_progress',
                    'row-critical': declaration.impact_level === 'critical'
                }">
                    <td>
                        <div class="ticket-number">
                            <i [class]="getStatusIcon(declaration.status)"></i>
                            <strong>{{ declaration.ticket_number }}</strong>
                        </div>
                    </td>
                    <td>
                        <div class="location-info">
                            <span class="line-name">{{ declaration.production_line_name }}</span>
                            <span class="workstation-name">{{ declaration.workstation_name }}</span>
                            <span class="machine-name" *ngIf="declaration.machine_name">
                                <i class="pi pi-cog"></i> {{ declaration.machine_name }}
                            </span>
                        </div>
                    </td>
                    <td>
                        <p-tag
                            [value]="declaration.declaration_type | titlecase"
                            [severity]="getTypeSeverity(declaration.declaration_type)">
                        </p-tag>
                    </td>
                    <td>
                        <p-tag
                            [value]="declaration.impact_level | titlecase"
                            [severity]="getImpactSeverity(declaration.impact_level)">
                        </p-tag>
                    </td>
                    <td>
                        <div class="reason-text" [pTooltip]="declaration.reason" tooltipPosition="top">
                            {{ declaration.reason }}
                        </div>
                    </td>
                    <td>
                        <p-tag
                            [value]="declaration.status | titlecase"
                            [severity]="getStatusSeverity(declaration.status)">
                        </p-tag>
                    </td>
                    <td>
                        <div class="datetime-info">
                            <span class="date-value">{{ formatDateTime(declaration.declared_at) }}</span>
                            <span class="by-value" *ngIf="declaration.declared_by_name">by {{ declaration.declared_by_name }}</span>
                        </div>
                    </td>
                    <td>
                        <span *ngIf="declaration.assigned_technician_name" class="technician-name">
                            <i class="pi pi-user"></i>
                            {{ declaration.assigned_technician_name }}
                        </span>
                        <span *ngIf="!declaration.assigned_technician_name" class="not-assigned">
                            Not assigned
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <!-- Only Cancel and Delete available for production users -->
                            <!-- Acknowledge, Start Work, Resolve are for maintenance managers in dms-maintenance -->
                            <p-button
                                *ngIf="canCancel(declaration)"
                                icon="pi pi-times"
                                [rounded]="true"
                                [text]="true"
                                severity="warn"
                                pTooltip="Annuler"
                                (click)="openActionDialog(declaration, 'cancel')">
                            </p-button>
                            <p-button
                                *ngIf="canDelete(declaration)"
                                icon="pi pi-trash"
                                [rounded]="true"
                                [text]="true"
                                severity="danger"
                                pTooltip="Supprimer"
                                (click)="deleteDeclaration(declaration)">
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <i class="pi pi-inbox empty-icon"></i>
                            <p class="empty-title">No declarations found</p>
                            <p class="empty-subtitle">Create a new declaration to notify the maintenance team</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>
</div>

<!-- New Declaration Dialog -->
<p-dialog
    [(visible)]="showDeclarationDialog"
    [header]="isEditMode ? 'Edit Declaration' : 'New Downtime Declaration'"
    [modal]="true"
    [style]="{ width: '700px', maxWidth: '95vw' }"
    [draggable]="false"
    [resizable]="false"
    styleClass="declaration-dialog">

    <div class="dialog-content">
        <form [formGroup]="declarationForm">
            <!-- Impact Level Selection - Visual Buttons -->
            <div class="impact-selection">
                <label class="section-label">
                    <i class="pi pi-exclamation-triangle"></i> Impact Level *
                </label>
                <div class="impact-options">
                    <div class="impact-option"
                         [class.selected]="declarationForm.get('impact_level')?.value === 'low'"
                         [class.impact-low]="true"
                         (click)="selectImpactLevel('low')">
                        <i class="pi pi-check-circle"></i>
                        <span class="impact-label">Low</span>
                        <span class="impact-desc">Minor issue</span>
                    </div>
                    <div class="impact-option"
                         [class.selected]="declarationForm.get('impact_level')?.value === 'medium'"
                         [class.impact-medium]="true"
                         (click)="selectImpactLevel('medium')">
                        <i class="pi pi-info-circle"></i>
                        <span class="impact-label">Medium</span>
                        <span class="impact-desc">Moderate</span>
                    </div>
                    <div class="impact-option"
                         [class.selected]="declarationForm.get('impact_level')?.value === 'high'"
                         [class.impact-high]="true"
                         (click)="selectImpactLevel('high')">
                        <i class="pi pi-exclamation-circle"></i>
                        <span class="impact-label">High</span>
                        <span class="impact-desc">Significant</span>
                    </div>
                    <div class="impact-option"
                         [class.selected]="declarationForm.get('impact_level')?.value === 'critical'"
                         [class.impact-critical]="true"
                         (click)="selectImpactLevel('critical')">
                        <i class="pi pi-bolt"></i>
                        <span class="impact-label">Critical</span>
                        <span class="impact-desc">Line stopped</span>
                    </div>
                </div>
            </div>

            <!-- Declaration Type Selection - Visual Buttons -->
            <div class="type-selection">
                <label class="section-label">
                    <i class="pi pi-tag"></i> Type *
                </label>
                <div class="type-options">
                    <div class="type-option"
                         [class.selected]="declarationForm.get('declaration_type')?.value === 'planned'"
                         (click)="selectDeclarationType('planned')">
                        <i class="pi pi-calendar"></i>
                        <span class="type-label">Planned</span>
                        <span class="type-desc">Scheduled maintenance</span>
                    </div>
                    <div class="type-option"
                         [class.selected]="declarationForm.get('declaration_type')?.value === 'unplanned'"
                         (click)="selectDeclarationType('unplanned')">
                        <i class="pi pi-exclamation-triangle"></i>
                        <span class="type-label">Unplanned</span>
                        <span class="type-desc">Unexpected issue</span>
                    </div>
                    <div class="type-option"
                         [class.selected]="declarationForm.get('declaration_type')?.value === 'emergency'"
                         (click)="selectDeclarationType('emergency')">
                        <i class="pi pi-bolt"></i>
                        <span class="type-label">Emergency</span>
                        <span class="type-desc">Immediate action</span>
                    </div>
                </div>
            </div>

            <p-divider></p-divider>

            <!-- Project Selection -->
            <div class="section-header">
                <i class="pi pi-briefcase"></i>
                <span>Project</span>
            </div>

            <div class="form-field mb-3">
                <label for="project">Project *</label>
                <p-select
                    id="project"
                    [options]="projects"
                    formControlName="project"
                    optionLabel="Name_Project"
                    placeholder="Select project"
                    [filter]="true"
                    filterBy="Name_Project"
                    appendTo="body"
                    styleClass="w-full">
                    <ng-template let-project pTemplate="item">
                        <div class="project-item">
                            <i class="pi pi-briefcase"></i>
                            <span>{{ project.Name_Project }}</span>
                        </div>
                    </ng-template>
                </p-select>
                <small class="error-text" *ngIf="declarationForm.get('project')?.invalid && declarationForm.get('project')?.touched">
                    Required
                </small>
            </div>

            <p-divider></p-divider>

            <!-- Location Section -->
            <div class="section-header">
                <i class="pi pi-map-marker"></i>
                <span>Location</span>
            </div>

            <div class="form-grid-4">
                <div class="form-field">
                    <label for="zone">Zone *</label>
                    <p-select
                        id="zone"
                        [options]="zones"
                        formControlName="zone"
                        optionLabel="name"
                        placeholder="Select zone"
                        [filter]="true"
                        filterBy="name"
                        appendTo="body"
                        styleClass="w-full">
                        <ng-template let-zone pTemplate="item">
                            <div class="zone-item">
                                <i class="pi pi-building"></i>
                                <span>{{ zone.name }}</span>
                            </div>
                        </ng-template>
                    </p-select>
                    <small class="error-text" *ngIf="declarationForm.get('zone')?.invalid && declarationForm.get('zone')?.touched">
                        Required
                    </small>
                </div>
                <div class="form-field">
                    <label for="production_line">Production Line *</label>
                    <p-select
                        id="production_line"
                        [options]="productionLines"
                        formControlName="production_line"
                        optionLabel="name"
                        placeholder="Select line"
                        [filter]="true"
                        filterBy="name"
                        appendTo="body"
                        styleClass="w-full"
                        [disabled]="!declarationForm.get('project')?.value || !declarationForm.get('zone')?.value">
                    </p-select>
                    <small class="error-text" *ngIf="declarationForm.get('production_line')?.invalid && declarationForm.get('production_line')?.touched && declarationForm.get('production_line')?.enabled">
                        Required
                    </small>
                </div>
                <div class="form-field">
                    <label for="workstation">Workstation *</label>
                    <p-select
                        id="workstation"
                        [options]="workstations"
                        formControlName="workstation"
                        optionLabel="Name_Workstation"
                        placeholder="Select workstation"
                        [filter]="true"
                        filterBy="Name_Workstation"
                        appendTo="body"
                        styleClass="w-full"
                        [disabled]="!declarationForm.get('project')?.value">
                    </p-select>
                    <small class="error-text" *ngIf="declarationForm.get('workstation')?.invalid && declarationForm.get('workstation')?.touched && declarationForm.get('workstation')?.enabled">
                        Required
                    </small>
                </div>
                <div class="form-field">
                    <label for="machine">Machine</label>
                    <p-select
                        id="machine"
                        [options]="machines"
                        formControlName="machine"
                        optionLabel="name"
                        placeholder="Select machine"
                        [filter]="true"
                        filterBy="name"
                        [showClear]="true"
                        appendTo="body"
                        styleClass="w-full">
                        <ng-template let-machine pTemplate="item">
                            <div class="machine-item">
                                <span>{{ machine.name }}</span>
                                <small>({{ machine.code }})</small>
                            </div>
                        </ng-template>
                    </p-select>
                </div>
            </div>

            <p-divider></p-divider>

            <!-- Description Section -->
            <div class="section-header">
                <i class="pi pi-info-circle"></i>
                <span>Description</span>
            </div>

            <div class="form-field">
                <label for="reason">Description *</label>
                <textarea
                    id="reason"
                    pTextarea
                    formControlName="reason"
                    rows="3"
                    class="w-full"
                    placeholder="Describe the problem and what happened...">
                </textarea>
                <div class="field-footer">
                    <small class="error-text" *ngIf="declarationForm.get('reason')?.invalid && declarationForm.get('reason')?.touched">
                        Minimum 10 characters required
                    </small>
                    <small class="char-count">{{ declarationForm.get('reason')?.value?.length || 0 }} / 10 min</small>
                </div>
            </div>

            <!-- Notification Info (always active) -->
            <div class="notification-info">
                <i class="pi pi-bell"></i>
                <span>L'équipe de maintenance sera notifiée automatiquement</span>
            </div>
        </form>
    </div>

    <ng-template pTemplate="footer">
        <div class="dialog-footer">
            <div class="footer-actions">
                <p-button
                    label="Annuler"
                    icon="pi pi-times"
                    [text]="true"
                    (click)="showDeclarationDialog = false">
                </p-button>
                <p-button
                    label="Déclarer & Notifier"
                    icon="pi pi-bell"
                    severity="warn"
                    (click)="saveDeclaration()"
                    [disabled]="declarationForm.invalid"
                    [loading]="isSaving">
                </p-button>
            </div>
        </div>
    </ng-template>
</p-dialog>

<!-- Action Dialog (Cancel only for production users) -->
<p-dialog
    [(visible)]="showActionDialog"
    header="Annuler la déclaration"
    [modal]="true"
    [style]="{ width: '500px' }"
    [draggable]="false"
    [resizable]="false">

    <div class="dialog-content" *ngIf="actionDeclaration">
        <!-- Declaration summary -->
        <div class="dialog-info">
            <div class="info-header">
                <span class="ticket-badge">{{ actionDeclaration.ticket_number }}</span>
                <p-tag [value]="actionDeclaration.status | titlecase" [severity]="getStatusSeverity(actionDeclaration.status)"></p-tag>
            </div>
            <div class="info-location">
                <i class="pi pi-map-marker"></i>
                {{ actionDeclaration.production_line_name }} - {{ actionDeclaration.workstation_name }}
            </div>
            <div class="info-reason">{{ actionDeclaration.reason }}</div>
        </div>

        <p-divider></p-divider>

        <form [formGroup]="actionForm">
            <!-- Cancel: reason -->
            <div class="form-field">
                <label for="cancel_reason"><i class="pi pi-times-circle"></i> Raison d'annulation</label>
                <textarea
                    id="cancel_reason"
                    pTextarea
                    formControlName="cancel_reason"
                    rows="3"
                    class="w-full"
                    placeholder="Indiquez la raison de l'annulation...">
                </textarea>
            </div>
        </form>
    </div>

    <ng-template pTemplate="footer">
        <p-button
            label="Retour"
            icon="pi pi-arrow-left"
            [text]="true"
            (click)="showActionDialog = false">
        </p-button>
        <p-button
            label="Confirmer l'annulation"
            icon="pi pi-times"
            severity="warn"
            (click)="executeAction()">
        </p-button>
    </ng-template>
</p-dialog>

<!-- Confirm Dialog -->
<p-confirmDialog></p-confirmDialog>

<!-- Toast -->
<p-toast position="top-right"></p-toast>
