<div class="production-workflow-container">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Production Workflow - Hourly Tracking</h1>
            <p class="page-subtitle">Manage shift setup, team assignment, and hourly production tracking</p>
        </div>
        <div class="header-time">
            <span class="current-time">{{ currentTime | date:'HH:mm:ss' }}</span>
            <span class="current-date">{{ currentTime | date:'dd/MM/yyyy' }}</span>
        </div>
    </div>

    <!-- Real-time Summary Cards -->
    <div class="summary-grid">
        <p-card styleClass="summary-card">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--blue-100);">
                    <i class="pi pi-clock" style="color: var(--blue-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Current Hour</span>
                    <span class="summary-value">H{{ getCurrentHour() }}</span>
                </div>
                <div class="summary-progress">
                    <p-progressBar [value]="hourProgress" [showValue]="false" styleClass="hour-progress"></p-progressBar>
                    <span class="progress-label">{{ hourProgress }}% completed</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--green-100);">
                    <i class="pi pi-box" style="color: var(--green-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Shift Total</span>
                    <span class="summary-value">{{ shiftTotalOutput }} / {{ shiftTotalTarget }}</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card" [ngClass]="{'card-success': shiftOverallEfficiency >= 95, 'card-warning': shiftOverallEfficiency >= 80 && shiftOverallEfficiency < 95, 'card-danger': shiftOverallEfficiency < 80}">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--purple-100);">
                    <i class="pi pi-chart-line" style="color: var(--purple-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Overall Efficiency</span>
                    <span class="summary-value">{{ shiftOverallEfficiency }}%</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--red-100);">
                    <i class="pi pi-exclamation-triangle" style="color: var(--red-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Total Downtime</span>
                    <span class="summary-value">{{ shiftTotalDowntime }} min</span>
                </div>
            </div>
        </p-card>
    </div>

    <!-- SHIFT SETUP -->
    <p-card styleClass="setup-card">
        <ng-template pTemplate="header">
            <div class="card-header">
                <div class="header-left">
                    <i class="pi pi-cog header-icon"></i>
                    <h2 class="card-title">Shift Setup</h2>
                    <p-tag *ngIf="session.isSetupComplete" value="✓ Complete" severity="success"></p-tag>
                    <p-tag *ngIf="!session.isSetupComplete" value="Required" severity="danger"></p-tag>
                </div>
                <div class="header-actions">
                    <p-button
                        *ngIf="session.isSetupComplete"
                        label="Edit Setup"
                        icon="pi pi-pencil"
                        [text]="true"
                        (click)="editShiftSetup()">
                    </p-button>
                </div>
            </div>
        </ng-template>

        <div *ngIf="!session.isSetupComplete">
            <form [formGroup]="shiftSetupForm" class="setup-form">
                <div class="form-grid">
                    <div class="form-field">
                        <label for="shift">Shift *</label>
                        <p-select
                            id="shift"
                            formControlName="shift"
                            [options]="shifts"
                            optionLabel="name"
                            placeholder="Select Shift"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>

                    <div class="form-field">
                        <label for="date">Date *</label>
                        <p-datepicker
                            id="date"
                            formControlName="date"
                            [showIcon]="true"
                            dateFormat="dd/mm/yy"
                            [style]="{ width: '100%' }">
                        </p-datepicker>
                    </div>

                    <div class="form-field">
                        <label for="project">Project *</label>
                        <p-select
                            id="project"
                            formControlName="project"
                            [options]="projects"
                            optionLabel="Name_Project"
                            placeholder="Select Project"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>

                    <div class="form-field">
                        <label for="productionLine">Production Line *</label>
                        <p-select
                            id="productionLine"
                            formControlName="productionLine"
                            [options]="productionLines"
                            optionLabel="name"
                            placeholder="Select Line"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>

                    <div class="form-field">
                        <label for="partNumber">Part Number *</label>
                        <p-select
                            id="partNumber"
                            formControlName="partNumber"
                            [options]="parts"
                            optionLabel="PN_Part"
                            placeholder="Select Part"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>

                    <div class="form-field">
                        <label for="zone">Zone</label>
                        <p-select
                            id="zone"
                            formControlName="zone"
                            [options]="zones"
                            optionLabel="name"
                            placeholder="Select Zone"
                            [showClear]="true"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>

                    <div class="form-field">
                        <label for="orderNo">Order NO</label>
                        <input
                            id="orderNo"
                            type="text"
                            pInputText
                            [(ngModel)]="session.orderNo"
                            [ngModelOptions]="{standalone: true}"
                            (ngModelChange)="onOrderNoChange()"
                            placeholder="Enter Order Number"
                            class="w-full">
                    </div>
                </div>

                <div class="form-actions">
                    <p-button
                        label="Complete Shift Setup"
                        icon="pi pi-check"
                        [disabled]="shiftSetupForm.invalid"
                        (click)="completeShiftSetup()">
                    </p-button>
                </div>
            </form>
        </div>

        <div *ngIf="session.isSetupComplete" class="setup-summary">
            <div class="summary-item">
                <span class="summary-label">Shift:</span>
                <span class="summary-value">{{ session.shift?.name }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Date:</span>
                <span class="summary-value">{{ session.date | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Project:</span>
                <span class="summary-value">{{ session.project?.Name_Project }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Line:</span>
                <span class="summary-value">{{ session.productionLine?.name }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Part:</span>
                <span class="summary-value">{{ session.part?.PN_Part }}</span>
            </div>
            <div class="summary-item" *ngIf="session.machine">
                <span class="summary-label">Machine:</span>
                <span class="summary-value">{{ session.machine.name }}</span>
            </div>
            <div class="summary-item" *ngIf="session.zone">
                <span class="summary-label">Zone:</span>
                <span class="summary-value">{{ session.zone.name }}</span>
            </div>
            <div class="summary-item" *ngIf="session.orderNo">
                <span class="summary-label">Order NO:</span>
                <span class="summary-value">{{ session.orderNo }}</span>
            </div>
        </div>
    </p-card>

    <!-- TEAM ASSIGNMENT -->
    <p-card styleClass="team-card" *ngIf="session.isSetupComplete">
        <ng-template pTemplate="header">
            <div class="card-header">
                <div class="header-left">
                    <i class="pi pi-users header-icon"></i>
                    <h2 class="card-title">Team Assignment</h2>
                    <p-tag *ngIf="session.isTeamComplete" [value]="team.length + ' Assigned'" severity="success"></p-tag>
                    <p-tag *ngIf="!session.isTeamComplete" value="Assign Team" severity="warn"></p-tag>
                </div>
                <div class="header-actions">
                    <p-button
                        *ngIf="session.isTeamComplete"
                        label="Edit Team"
                        icon="pi pi-pencil"
                        [text]="true"
                        (click)="editTeamAssignment()">
                    </p-button>
                </div>
            </div>
        </ng-template>

        <div *ngIf="!session.isTeamComplete">
            <!-- Simplified Team Assignment Form - Just scan badge -->
            <div class="team-assignment-form">
                <div class="form-row">
                    <div class="form-field flex-grow">
                        <label for="employeeScan"><i class="pi pi-id-card"></i> Scan Employee Badge</label>
                        <div class="p-inputgroup">
                            <input
                                id="employeeScan"
                                type="text"
                                pInputText
                                [(ngModel)]="employeeIdScan"
                                placeholder="Scan employee badge"
                                (keyup.enter)="addEmployee()"
                                class="w-full">
                            <p-button
                                icon="pi pi-plus"
                                label="Add Employee"
                                (click)="addEmployee()">
                            </p-button>
                        </div>
                        <small class="text-color-secondary mt-1 block">
                            <i class="pi pi-info-circle"></i> Workstation and machine will be auto-filled from employee's default assignment
                        </small>
                    </div>
                </div>
            </div>

            <!-- Manual Workstation Selection (shown when no default assignment exists) -->
            <div *ngIf="showManualWorkstationSelection" class="manual-selection-form surface-ground p-3 border-round mt-3">
                <div class="flex align-items-center gap-2 mb-3">
                    <i class="pi pi-exclamation-circle text-orange-500 text-xl"></i>
                    <span class="font-semibold">Manual Selection Required</span>
                    <span class="text-color-secondary ml-2" *ngIf="pendingEmployeeData">
                        for {{ pendingEmployeeData.first_name }} {{ pendingEmployeeData.last_name }}
                    </span>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="workstation"><i class="pi pi-desktop"></i> Workstation *</label>
                        <p-select
                            id="workstation"
                            [(ngModel)]="selectedWorkstation"
                            [options]="workstations"
                            optionLabel="Name_Workstation"
                            placeholder="Select Workstation"
                            (onChange)="onWorkstationChange()"
                            [style]="{ width: '250px' }">
                        </p-select>
                    </div>

                    <div class="form-field">
                        <label for="machineAssignment"><i class="pi pi-cog"></i> Machine</label>
                        <p-select
                            id="machineAssignment"
                            [(ngModel)]="selectedMachineForAssignment"
                            [options]="filteredMachinesForAssignment"
                            optionLabel="name"
                            placeholder="Select Machine (Optional)"
                            [showClear]="true"
                            [disabled]="!selectedWorkstation"
                            [style]="{ width: '250px' }">
                        </p-select>
                    </div>

                    <div class="form-field button-field flex gap-2">
                        <p-button
                            icon="pi pi-check"
                            label="Confirm"
                            (click)="addEmployeeManual()"
                            [disabled]="!selectedWorkstation">
                        </p-button>
                        <p-button
                            icon="pi pi-times"
                            label="Cancel"
                            severity="secondary"
                            (click)="cancelManualSelection()">
                        </p-button>
                    </div>
                </div>
            </div>

            <p-divider></p-divider>

            <p-table [value]="team" [tableStyle]="{ 'min-width': '70rem' }">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Badge</th>
                        <th>Categorie</th>
                        <th>Workstation</th>
                        <th>Machine</th>
                        <th>Qualification</th>
                        <th>Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-emp>
                    <tr>
                        <td>
                            <p-avatar [image]="emp.Picture" shape="circle" size="large"></p-avatar>
                        </td>
                        <td><span class="employee-name">{{ emp.Prenom_Emp }} {{ emp.Nom_Emp }}</span></td>
                        <td><span class="employee-badge">{{ emp.badgeId || emp.BadgeNumber || ('EMP-' + emp.Id_Emp) }}</span></td>
                        <td>
                            <p-tag [value]="emp.Categorie_Emp || emp.role || 'Operator'" [severity]="getRoleSeverity(emp.role)"></p-tag>
                        </td>
                        <td>{{ emp.workstation }}</td>
                        <td>
                            <span *ngIf="emp.machine">{{ emp.machine }}</span>
                            <span *ngIf="!emp.machine" class="text-gray-400">-</span>
                        </td>
                        <td>
                            <p-tag [value]="emp.qualification" [severity]="getQualificationSeverity(emp.qualificationLevel)"></p-tag>
                        </td>
                        <td>
                            <p-button icon="pi pi-trash" severity="danger" [text]="true" [rounded]="true" (click)="removeEmployee(emp)"></p-button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="empty-state">
                                <i class="pi pi-users empty-icon"></i>
                                <p class="empty-title">No employees assigned yet</p>
                                <p class="empty-subtitle">Scan employee badges to auto-assign them to their default workstations</p>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>

            <div class="form-actions">
                <p-button
                    label="Complete Team Assignment"
                    icon="pi pi-check"
                    [disabled]="team.length === 0"
                    (click)="completeTeamAssignment()">
                </p-button>
            </div>
        </div>

        <div *ngIf="session.isTeamComplete" class="team-summary">
            <div class="summary-row">
                <div class="summary-item">
                    <i class="pi pi-users summary-icon"></i>
                    <span class="summary-label">Team Members:</span>
                    <span class="summary-value">{{ team.length }}</span>
                </div>
                <div class="summary-item" *ngIf="session.actors.lineLeader.name">
                    <i class="pi pi-user summary-icon"></i>
                    <span class="summary-label">Line Leader:</span>
                    <span class="summary-value">{{ session.actors.lineLeader.name }}</span>
                </div>
            </div>
        </div>
    </p-card>

    <!-- HOURLY PRODUCTION TRACKER -->
    <p-card styleClass="tracker-card" *ngIf="session.isSetupComplete && session.isTeamComplete">
        <ng-template pTemplate="header">
            <div class="card-header">
                <div class="header-left">
                    <i class="pi pi-clock header-icon"></i>
                    <h2 class="card-title">Hourly Production Tracker</h2>
                    <p-tag [value]="completedHours + ' / ' + session.hours.length + ' Hours'" severity="info"></p-tag>
                </div>
                <div class="header-actions">
                    <p-button label="Reset Session" icon="pi pi-refresh" severity="secondary" [text]="true" (click)="resetSession()"></p-button>
                </div>
            </div>
        </ng-template>

        <p-table [value]="session.hours" styleClass="hourly-tracker-table" [rowHover]="true">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 80px">Hour</th>
                    <th style="width: 150px">Time Range</th>
                    <th style="width: 140px">Type</th>
                    <th style="width: 120px">Status</th>
                    <th style="width: 100px">Output</th>
                    <th style="width: 100px">Target</th>
                    <th style="width: 100px">Efficiency</th>
                    <th style="width: 100px">Scrap</th>
                    <th style="width: 120px">Downtime</th>
                    <th style="width: 200px">Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-hour let-i="rowIndex">
                <tr [ngClass]="{'hour-overtime': hour.isOvertime, 'hour-completed': hour.status === 'completed', 'hour-in-progress': hour.status === 'in_progress'}">
                    <td>
                        <div class="hour-number">
                            <i [class]="'pi ' + getHourStatusIcon(hour.status)"></i>
                            <strong>H{{ hour.hour }}</strong>
                        </div>
                    </td>
                    <td>
                        <span class="time-range">{{ hour.timeRange }}</span>
                    </td>
                    <td>
                        <p-select
                            [options]="hourTypeOptions"
                            [(ngModel)]="hour.hourType"
                            (ngModelChange)="onHourTypeChange(i, $event)"
                            optionLabel="label"
                            optionValue="value"
                            [style]="{ width: '140px' }"
                            placeholder="Select type"
                            appendTo="body">
                            <ng-template pTemplate="item" let-option>
                                <p-tag
                                    [value]="option.label"
                                    [severity]="getHourTypeSeverity(option.value)">
                                </p-tag>
                            </ng-template>
                        </p-select>
                    </td>
                    <td>
                        <p-tag
                            [value]="getHourStatusLabel(hour.status)"
                            [severity]="hour.status === 'completed' ? 'success' : hour.status === 'in_progress' ? 'warn' : 'secondary'">
                        </p-tag>
                    </td>
                    <td class="text-center">
                        <span class="metric-value" *ngIf="hour.output !== null">{{ hour.output }}</span>
                        <span class="metric-placeholder" *ngIf="hour.output === null">--</span>
                    </td>
                    <td class="text-center">
                        <span class="target-value">{{ hour.target }}</span>
                    </td>
                    <td class="text-center">
                        <p-tag
                            *ngIf="hour.efficiency !== null"
                            [value]="hour.efficiency + '%'"
                            [severity]="getEfficiencySeverity(hour.efficiency)">
                        </p-tag>
                        <span class="metric-placeholder" *ngIf="hour.efficiency === null">--</span>
                    </td>
                    <td class="text-center">
                        <span class="scrap-value" *ngIf="hour.scrap !== null">{{ hour.scrap }}</span>
                        <span class="metric-placeholder" *ngIf="hour.scrap === null">--</span>
                    </td>
                    <td class="text-center">
                        <div *ngIf="hour.totalDowntime > 0" class="downtime-info">
                            <i class="pi pi-exclamation-triangle downtime-icon"></i>
                            <span class="downtime-value">{{ hour.totalDowntime }} min</span>
                            <span class="downtime-count" *ngIf="hour.downtimes.length > 1">({{ hour.downtimes.length }})</span>
                        </div>
                        <span class="metric-placeholder" *ngIf="hour.totalDowntime === 0">--</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <p-button
                                *ngIf="hour.status === 'not_started' || hour.status === 'completed'"
                                [label]="hour.status === 'completed' ? 'Edit' : 'Enter'"
                                [icon]="hour.status === 'completed' ? 'pi pi-pencil' : 'pi pi-play'"
                                [severity]="hour.status === 'completed' ? 'info' : 'success'"
                                size="small"
                                (click)="openHourDialog(i)">
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="10" class="text-center">
                        <div class="empty-state">
                            <i class="pi pi-clock empty-icon"></i>
                            <p class="empty-title">No hours configured</p>
                            <p class="empty-subtitle">Complete shift setup to generate hourly tracking</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <!-- Shift Summary Footer -->
        <div class="tracker-footer">
            <div class="footer-metrics">
                <div class="footer-metric">
                    <span class="metric-label">Shift Total:</span>
                    <span class="metric-value">{{ shiftTotalOutput }} / {{ shiftTotalTarget }}</span>
                </div>
                <div class="footer-metric">
                    <span class="metric-label">Overall Efficiency:</span>
                    <p-tag [value]="shiftOverallEfficiency + '%'" [severity]="getEfficiencySeverity(shiftOverallEfficiency)"></p-tag>
                </div>
                <div class="footer-metric">
                    <span class="metric-label">Total Scrap:</span>
                    <span class="metric-value scrap">{{ shiftTotalScrap }} pieces</span>
                </div>
                <div class="footer-metric">
                    <span class="metric-label">Total Downtime:</span>
                    <span class="metric-value downtime">{{ shiftTotalDowntime }} minutes</span>
                </div>
            </div>
            <div class="footer-actions">
                <p-button
                    label="Rapport Detaille"
                    icon="pi pi-file-pdf"
                    severity="info"
                    [outlined]="true"
                    (click)="openShiftReport()"
                    [disabled]="completedHours === 0">
                </p-button>
            </div>
        </div>
    </p-card>

    <!-- Empty State (when setup not complete) -->
    <p-card *ngIf="!session.isSetupComplete || !session.isTeamComplete" styleClass="empty-tracker-card">
        <div class="empty-state-large">
            <i class="pi pi-clock empty-icon-large"></i>
            <h3 class="empty-title-large">Start Your Shift Production Tracking</h3>
            <p class="empty-subtitle-large" *ngIf="!session.isSetupComplete">Complete shift setup above to begin tracking hourly production</p>
            <p class="empty-subtitle-large" *ngIf="session.isSetupComplete && !session.isTeamComplete">Assign your team to start tracking production</p>
        </div>
    </p-card>
</div>

<!-- HOUR PRODUCTION DIALOG -->
<p-dialog
    header="Enter Production - Hour {{ selectedHourIndex !== null && session.hours[selectedHourIndex] ? session.hours[selectedHourIndex].hour : '' }}"
    [(visible)]="showHourDialog"
    [modal]="true"
    [style]="{ width: '600px' }"
    [draggable]="false"
    [resizable]="false">

    <div class="dialog-content" *ngIf="selectedHourIndex !== null && session.hours[selectedHourIndex]">
        <div class="dialog-header-info">
            <div class="info-item">
                <i class="pi pi-clock"></i>
                <span>{{ session.hours[selectedHourIndex].timeRange }}</span>
            </div>
            <div class="info-item">
                <i class="pi pi-calendar"></i>
                <span>{{ session.date | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="info-item">
                <i class="pi pi-sun"></i>
                <span>{{ session.shift?.name }}</span>
            </div>
        </div>

        <p-divider></p-divider>

        <!-- TEAM CONFIRMATION SECTION -->
        <div *ngIf="showTeamConfirmationStep && !teamConfirmed" class="team-confirmation-section">
            <div class="confirmation-header">
                <i class="pi pi-users"></i>
                <h4>Confirmation de l'equipe</h4>
            </div>

            <div class="confirmation-question">
                <p>Les employes sont-ils les memes que pour l'heure precedente ?</p>
                <div class="previous-team-summary">
                    <span>Equipe precedente: {{ getPreviousHourTeam(selectedHourIndex).length }} employes</span>
                </div>
            </div>

            <div class="confirmation-buttons">
                <p-button
                    label="Oui, meme equipe"
                    icon="pi pi-check"
                    severity="success"
                    (click)="confirmTeamSameAsPrevious()">
                </p-button>
                <p-button
                    label="Non, modifier l'equipe"
                    icon="pi pi-pencil"
                    severity="warn"
                    (click)="confirmTeamDifferent()">
                </p-button>
            </div>
        </div>

        <!-- TEAM EDITING SECTION (when user selects "Non") -->
        <div *ngIf="!showTeamConfirmationStep && !teamConfirmed" class="hour-team-section">
            <div class="team-section-header">
                <h4 class="section-title"><i class="pi pi-users"></i> Modifier l'equipe ({{ currentHourTeam.length }})</h4>
            </div>

            <!-- Badge scan pour ajout -->
            <div class="team-add-form">
                <div class="p-inputgroup">
                    <input
                        pInputText
                        [(ngModel)]="employeeScanForHour"
                        placeholder="Scanner badge employe"
                        (keyup.enter)="addEmployeeToHourTeam()"
                        class="w-full">
                    <p-button icon="pi pi-plus" label="Ajouter" (click)="addEmployeeToHourTeam()"></p-button>
                </div>
            </div>

            <!-- Liste des employes de l'heure -->
            <p-table [value]="currentHourTeam" styleClass="p-datatable-sm" [scrollable]="true" scrollHeight="200px">
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 50px"></th>
                        <th>Employe</th>
                        <th>Poste</th>
                        <th style="width: 60px">Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-emp>
                    <tr>
                        <td>
                            <p-avatar [image]="emp.Picture" shape="circle" size="normal"></p-avatar>
                        </td>
                        <td>{{ emp.Prenom_Emp }} {{ emp.Nom_Emp }}</td>
                        <td>{{ emp.workstation }}</td>
                        <td>
                            <p-button icon="pi pi-trash" severity="danger" [text]="true" [rounded]="true"
                                      (click)="removeEmployeeFromHourTeam(emp)"></p-button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="4" class="text-center text-color-secondary">
                            Aucun employe assigne. Scannez des badges pour ajouter.
                        </td>
                    </tr>
                </ng-template>
            </p-table>

            <!-- Bouton pour confirmer apres modification -->
            <div class="team-actions">
                <p-button
                    label="Confirmer l'equipe ({{ currentHourTeam.length }})"
                    icon="pi pi-check"
                    (click)="confirmHourTeam()"
                    [disabled]="currentHourTeam.length === 0">
                </p-button>
            </div>
        </div>

        <!-- TEAM SUMMARY (when team is confirmed) -->
        <div *ngIf="teamConfirmed" class="team-confirmed-summary">
            <div class="flex align-items-center justify-content-between">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-users text-primary"></i>
                    <span class="font-medium">Equipe: {{ currentHourTeam.length }} employes</span>
                </div>
                <p-button
                    label="Modifier"
                    icon="pi pi-pencil"
                    [text]="true"
                    size="small"
                    (click)="confirmTeamDifferent()">
                </p-button>
            </div>
        </div>

        <p-divider *ngIf="teamConfirmed"></p-divider>

        <!-- PRODUCTION METRICS (only show when team confirmed) -->
        <div *ngIf="teamConfirmed">
            <h4 class="section-title"><i class="pi pi-box"></i> Production Metrics</h4>

            <div class="metrics-input-grid">
            <div class="metric-input-card">
                <label>Output</label>
                <p-inputNumber
                    [(ngModel)]="hourProductionInput.output"
                    [showButtons]="true"
                    [min]="0"
                    inputStyleClass="large-input">
                </p-inputNumber>
                <span class="input-helper">Target: {{ session.hours[selectedHourIndex].target }}</span>
            </div>

            <div class="metric-input-card">
                <label>Scrap</label>
                <p-inputNumber
                    [(ngModel)]="hourProductionInput.scrap"
                    [showButtons]="true"
                    [min]="0"
                    inputStyleClass="large-input scrap-input">
                </p-inputNumber>
                <span class="input-helper">Target: ≤ {{ session.hours[selectedHourIndex].scrapTarget }}</span>
            </div>
        </div>

        <p-divider></p-divider>

        <h4 class="section-title">
            <i class="pi pi-exclamation-triangle"></i> Downtimes
            <span class="downtime-count-badge" *ngIf="hourProductionInput.downtimes && hourProductionInput.downtimes.length > 0">
                ({{ hourProductionInput.downtimes.length }})
            </span>
        </h4>

        <!-- Existing Downtimes List -->
        <div class="downtimes-list" *ngIf="hourProductionInput.downtimes && hourProductionInput.downtimes.length > 0">
            <div class="downtime-item" *ngFor="let dt of hourProductionInput.downtimes; let idx = index">
                <div class="downtime-item-content">
                    <div class="downtime-item-header">
                        <span class="downtime-duration">
                            <i class="pi pi-clock"></i>
                            {{ dt.duration }} min
                        </span>
                        <p-tag [value]="getDowntimeProblemName(dt.problemId)" severity="warn"></p-tag>
                        <p-tag *ngIf="dt.machineId" [value]="getMachineName(dt.machineId)" severity="info" icon="pi pi-cog"></p-tag>
                    </div>
                    <div class="downtime-item-comment" *ngIf="dt.comment">
                        {{ dt.comment }}
                    </div>
                </div>
                <div class="downtime-item-actions">
                    <p-button
                        icon="pi pi-pencil"
                        [text]="true"
                        [rounded]="true"
                        severity="info"
                        size="small"
                        pTooltip="Edit"
                        (click)="editDowntimeInDialog(idx)">
                    </p-button>
                    <p-button
                        icon="pi pi-trash"
                        [text]="true"
                        [rounded]="true"
                        severity="danger"
                        size="small"
                        pTooltip="Remove"
                        (click)="removeDowntimeFromDialog(idx)">
                    </p-button>
                </div>
            </div>
            <div class="downtime-total">
                <strong>Total Downtime:</strong> {{ getTotalDowntimeInDialog() }} min
            </div>
        </div>

        <!-- Add New Downtime Form -->
        <div class="add-downtime-section">
            <p-button
                *ngIf="!showAddDowntimeForm"
                label="Add Downtime"
                icon="pi pi-plus"
                [outlined]="true"
                size="small"
                (click)="showAddDowntimeForm = true; resetNewDowntimeForm()">
            </p-button>

            <div *ngIf="showAddDowntimeForm" class="new-downtime-form">
                <div class="form-grid">
                    <div class="form-field">
                        <label for="newDowntimeDuration">Duration (minutes) *</label>
                        <p-inputNumber
                            id="newDowntimeDuration"
                            [(ngModel)]="newDowntimeInput.duration"
                            [min]="1"
                            [max]="60"
                            [showButtons]="true"
                            suffix=" min"
                            [style]="{ width: '100%' }">
                        </p-inputNumber>
                    </div>

                    <div class="form-field">
                        <label for="newDowntimeProblem">Problem Category *</label>
                        <p-select
                            id="newDowntimeProblem"
                            [(ngModel)]="newDowntimeInput.problemId"
                            [options]="downtimeProblems"
                            optionLabel="Name_DowntimeProblems"
                            optionValue="Id_DowntimeProblems"
                            placeholder="Select Problem"
                            appendTo="body"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>

                    <div class="form-field">
                        <label for="newDowntimeMachine"><i class="pi pi-cog"></i> Machine</label>
                        <p-select
                            id="newDowntimeMachine"
                            [(ngModel)]="newDowntimeInput.machineId"
                            [options]="machines"
                            optionLabel="name"
                            optionValue="id"
                            placeholder="Select Machine (Optional)"
                            [showClear]="true"
                            appendTo="body"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>
                </div>

                <div class="form-field">
                    <label for="newDowntimeComment">Description</label>
                    <textarea
                        id="newDowntimeComment"
                        pTextarea
                        [(ngModel)]="newDowntimeInput.comment"
                        rows="2"
                        class="w-full"
                        placeholder="Describe the downtime issue...">
                    </textarea>
                </div>

                <div class="form-actions-inline">
                    <p-button
                        [label]="editingDowntimeDialogIndex !== null ? 'Update' : 'Add'"
                        icon="pi pi-check"
                        size="small"
                        (click)="confirmAddDowntimeInDialog()">
                    </p-button>
                    <p-button
                        label="Cancel"
                        icon="pi pi-times"
                        [text]="true"
                        size="small"
                        (click)="cancelAddDowntimeInDialog()">
                    </p-button>
                </div>
            </div>
        </div>
        </div> <!-- End of teamConfirmed wrapper -->
    </div>

    <ng-template pTemplate="footer">
        <p-button
            label="Cancel"
            icon="pi pi-times"
            [text]="true"
            (click)="closeHourDialog()">
        </p-button>
        <p-button
            label="Save Hour Production"
            icon="pi pi-check"
            [disabled]="!teamConfirmed"
            (click)="saveHourProduction()">
        </p-button>
    </ng-template>
</p-dialog>

<!-- DOWNTIME DIALOG (Add or Edit) -->
<p-dialog
    [header]="editingDowntimeIndex !== null ? 'Edit Downtime' : 'Add Downtime'"
    [(visible)]="showDowntimeDialog"
    [modal]="true"
    [style]="{ width: '500px' }"
    [draggable]="false"
    [resizable]="false">

    <div class="dialog-content" *ngIf="downtimeHourIndex !== null">
        <div class="dialog-info">
            <p><strong>Hour {{ session.hours[downtimeHourIndex].hour }}</strong> ({{ session.hours[downtimeHourIndex].timeRange }})</p>
            <p class="text-sm text-color-secondary" *ngIf="editingDowntimeIndex === null">Add downtime for this hour</p>
            <p class="text-sm text-color-secondary" *ngIf="editingDowntimeIndex !== null">Edit existing downtime for this hour</p>
        </div>

        <p-divider></p-divider>

        <div class="form-field">
            <label for="addDowntimeProblem">Problem Category *</label>
            <p-select
                id="addDowntimeProblem"
                [(ngModel)]="downtimeInput.Id_DowntimeProblems"
                [options]="downtimeProblems"
                optionLabel="Name_DowntimeProblems"
                optionValue="Id_DowntimeProblems"
                placeholder="Select problem"
                appendTo="body"
                [style]="{ width: '100%' }">
            </p-select>
        </div>

        <div class="form-field">
            <label for="addDowntimeDuration">Duration (minutes) *</label>
            <p-inputNumber
                id="addDowntimeDuration"
                [(ngModel)]="downtimeInput.Total_Downtime"
                [min]="1"
                [max]="60"
                [showButtons]="true"
                suffix=" min"
                [style]="{ width: '100%' }">
            </p-inputNumber>
        </div>

        <div class="form-field">
            <label for="addDowntimeComment">Description</label>
            <textarea
                id="addDowntimeComment"
                pTextarea
                [(ngModel)]="downtimeInput.Comment_Downtime"
                rows="3"
                class="w-full"
                placeholder="Describe the issue...">
            </textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button
            label="Cancel"
            icon="pi pi-times"
            [text]="true"
            (click)="closeDowntimeDialog()">
        </p-button>
        <p-button
            [label]="editingDowntimeIndex !== null ? 'Update' : 'Add'"
            icon="pi pi-check"
            (click)="saveAdditionalDowntime()">
        </p-button>
    </ng-template>
</p-dialog>

<!-- Qualification Warning Dialog -->
<p-dialog
    [(visible)]="showQualificationWarningDialog"
    header="Avertissement Qualification"
    [modal]="true"
    [style]="{width: '450px'}"
    [closable]="true"
    (onHide)="cancelQualificationWarning()">
    <div class="flex align-items-start gap-3 p-2">
        <i class="pi pi-exclamation-triangle text-4xl text-orange-500"></i>
        <div>
            <p class="m-0 line-height-3">{{ qualificationWarningMessage }}</p>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2">
            <p-button
                label="Non"
                icon="pi pi-times"
                severity="secondary"
                (click)="cancelQualificationWarning()">
            </p-button>
            <p-button
                label="Oui"
                icon="pi pi-check"
                severity="warn"
                (click)="confirmQualificationWarning()">
            </p-button>
        </div>
    </ng-template>
</p-dialog>

<!-- ==================== SHIFT REPORT DIALOG ==================== -->
<p-dialog
    header="Rapport Detaille du Shift"
    [(visible)]="showShiftReportDialog"
    [modal]="true"
    [style]="{ width: '90vw', maxWidth: '1200px' }"
    [maximizable]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="shift-report-dialog">

    <ng-template pTemplate="header">
        <div class="flex align-items-center gap-3">
            <i class="pi pi-file-pdf text-2xl text-primary"></i>
            <div>
                <h3 class="m-0">Rapport Detaille du Shift</h3>
                <span class="text-sm text-color-secondary">
                    {{ session.shift?.name || 'N/A' }} - {{ session.date | date:'dd/MM/yyyy' }}
                </span>
            </div>
        </div>
    </ng-template>

    <!-- Report Summary Section -->
    <div class="report-summary-section mb-4">
        <h4 class="section-title"><i class="pi pi-chart-bar"></i> Resume du Shift</h4>
        <div class="grid">
            <div class="col-6 md:col-2">
                <div class="summary-stat">
                    <span class="stat-label">Ligne</span>
                    <span class="stat-value">{{ session.productionLine?.name || 'N/A' }}</span>
                </div>
            </div>
            <div class="col-6 md:col-2">
                <div class="summary-stat">
                    <span class="stat-label">Piece</span>
                    <span class="stat-value">{{ session.part?.PN_Part || 'N/A' }}</span>
                </div>
            </div>
            <div class="col-6 md:col-2">
                <div class="summary-stat">
                    <span class="stat-label">Production</span>
                    <span class="stat-value text-primary">{{ shiftTotalOutput }} / {{ shiftTotalTarget }}</span>
                </div>
            </div>
            <div class="col-6 md:col-2">
                <div class="summary-stat">
                    <span class="stat-label">Efficacite</span>
                    <p-tag [value]="shiftOverallEfficiency + '%'" [severity]="getEfficiencySeverity(shiftOverallEfficiency)"></p-tag>
                </div>
            </div>
            <div class="col-6 md:col-2">
                <div class="summary-stat">
                    <span class="stat-label">Scrap</span>
                    <span class="stat-value text-orange-500">{{ shiftTotalScrap }} pcs</span>
                </div>
            </div>
            <div class="col-6 md:col-2">
                <div class="summary-stat">
                    <span class="stat-label">Downtime</span>
                    <span class="stat-value text-red-500">{{ shiftTotalDowntime }} min</span>
                </div>
            </div>
        </div>
    </div>

    <p-divider></p-divider>

    <!-- Hourly Breakdown Section -->
    <div class="hourly-breakdown-section mb-4">
        <h4 class="section-title"><i class="pi pi-clock"></i> Detail par Heure</h4>

        <p-table [value]="session.hours" styleClass="p-datatable-sm p-datatable-striped" [scrollable]="true">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 100px">Heure</th>
                    <th style="width: 120px">Plage Horaire</th>
                    <th style="width: 100px">Type</th>
                    <th class="text-center" style="width: 80px">Statut</th>
                    <th class="text-center" style="width: 100px">Output</th>
                    <th class="text-center" style="width: 80px">Target</th>
                    <th class="text-center" style="width: 100px">Efficacite</th>
                    <th class="text-center" style="width: 80px">Scrap</th>
                    <th class="text-center" style="width: 100px">Downtime</th>
                    <th class="text-center" style="width: 80px">Equipe</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-hour let-i="rowIndex">
                <tr [ngClass]="{'row-completed': hour.status === 'completed', 'row-in-progress': hour.status === 'in_progress'}">
                    <td><strong>H{{ i + 1 }}</strong></td>
                    <td>{{ hour.timeRange }}</td>
                    <td>
                        <p-tag
                            [value]="getHourTypeLabel(hour.hourType)"
                            [severity]="getHourTypeSeverity(hour.hourType)"
                            [rounded]="true">
                        </p-tag>
                    </td>
                    <td class="text-center">
                        <i [class]="'pi ' + getHourStatusIcon(hour.status)"
                           [ngClass]="{
                               'text-gray-400': hour.status === 'not_started',
                               'text-blue-500': hour.status === 'in_progress',
                               'text-green-500': hour.status === 'completed'
                           }">
                        </i>
                    </td>
                    <td class="text-center">
                        <strong *ngIf="hour.output !== null">{{ hour.output }}</strong>
                        <span *ngIf="hour.output === null" class="text-gray-400">-</span>
                    </td>
                    <td class="text-center">{{ hour.target }}</td>
                    <td class="text-center">
                        <p-tag *ngIf="hour.efficiency !== null"
                               [value]="hour.efficiency + '%'"
                               [severity]="getEfficiencySeverity(hour.efficiency)">
                        </p-tag>
                        <span *ngIf="hour.efficiency === null" class="text-gray-400">-</span>
                    </td>
                    <td class="text-center">
                        <span *ngIf="hour.scrap !== null" class="text-orange-500">{{ hour.scrap }}</span>
                        <span *ngIf="hour.scrap === null" class="text-gray-400">-</span>
                    </td>
                    <td class="text-center">
                        <span *ngIf="hour.totalDowntime > 0" class="text-red-500">{{ hour.totalDowntime }} min</span>
                        <span *ngIf="hour.totalDowntime === 0" class="text-gray-400">-</span>
                    </td>
                    <td class="text-center">
                        <p-tag [value]="getHourTeamCount(hour) + ' emp'" severity="secondary" [rounded]="true"></p-tag>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <p-divider></p-divider>

    <!-- Employee Work Hours Section -->
    <div class="employee-hours-section">
        <h4 class="section-title"><i class="pi pi-users"></i> Employes et Heures Travaillees</h4>

        <p-table [value]="getAllShiftEmployees()" styleClass="p-datatable-sm" [scrollable]="true" scrollHeight="300px">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 60px">Photo</th>
                    <th>Nom</th>
                    <th>Badge</th>
                    <th>Categorie</th>
                    <th>Poste</th>
                    <th>Heures Travaillees</th>
                    <th class="text-center" style="width: 100px">Total Heures</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-emp>
                <tr>
                    <td>
                        <p-avatar [image]="emp.Picture" shape="circle" size="normal"></p-avatar>
                    </td>
                    <td>
                        <strong>{{ emp.Prenom_Emp }} {{ emp.Nom_Emp }}</strong>
                    </td>
                    <td>
                        <span class="text-color-secondary">{{ emp.badgeId || emp.BadgeNumber || ('EMP-' + emp.Id_Emp) }}</span>
                    </td>
                    <td>
                        <p-tag [value]="emp.Categorie_Emp || emp.role || 'Operator'" [severity]="getRoleSeverity(emp.role)" [rounded]="true"></p-tag>
                    </td>
                    <td>{{ emp.workstation || 'Non assigne' }}</td>
                    <td>
                        <div class="hours-worked-grid">
                            <span *ngFor="let hour of session.hours; let i = index"
                                  class="hour-badge"
                                  [ngClass]="{
                                      'hour-worked': employeeWorkedHour(hour, emp.Id_Emp),
                                      'hour-not-worked': !employeeWorkedHour(hour, emp.Id_Emp)
                                  }">
                                H{{ i + 1 }}
                            </span>
                        </div>
                    </td>
                    <td class="text-center">
                        <p-tag [value]="getEmployeeHoursWorked(emp.Id_Emp).length + 'h'" severity="info"></p-tag>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7" class="text-center text-color-secondary p-4">
                        <i class="pi pi-users text-3xl mb-2"></i>
                        <p>Aucun employe enregistre pour ce shift</p>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-between align-items-center flex-wrap gap-2">
            <span class="text-color-secondary text-sm">
                <i class="pi pi-info-circle"></i>
                Genere le {{ currentTime | date:'dd/MM/yyyy HH:mm' }}
            </span>
            <div class="flex gap-2 flex-wrap">
                <p-button
                    label="CSV"
                    icon="pi pi-file"
                    severity="success"
                    [outlined]="true"
                    (click)="exportToCSV()"
                    pTooltip="Telecharger en format CSV">
                </p-button>
                <p-button
                    label="Excel"
                    icon="pi pi-file-excel"
                    severity="success"
                    (click)="exportToExcel()"
                    pTooltip="Telecharger en format Excel">
                </p-button>
                <p-button
                    label="PDF"
                    icon="pi pi-file-pdf"
                    severity="danger"
                    (click)="exportToPDF()"
                    pTooltip="Telecharger en format PDF">
                </p-button>
                <p-button
                    label="Fermer"
                    icon="pi pi-times"
                    severity="secondary"
                    (click)="closeShiftReport()">
                </p-button>
            </div>
        </div>
    </ng-template>
</p-dialog>

<p-toast position="top-right"></p-toast>
