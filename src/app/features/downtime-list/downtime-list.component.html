<div class="downtime-list-container">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Downtime List</h1>
            <p class="page-subtitle">Track and manage all downtime tickets</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-grid">
        <p-card styleClass="summary-card card-danger">
            <div class="summary-content">
                <div class="summary-icon danger">
                    <i class="pi pi-exclamation-circle"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-value">{{ openCount }}</span>
                    <span class="summary-label">Open Tickets</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card card-warning">
            <div class="summary-content">
                <div class="summary-icon warning">
                    <i class="pi pi-wrench"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-value">{{ inProgressCount }}</span>
                    <span class="summary-label">In Progress</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card card-success">
            <div class="summary-content">
                <div class="summary-icon success">
                    <i class="pi pi-check-circle"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-value">{{ closedCount }}</span>
                    <span class="summary-label">Closed</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card">
            <div class="summary-content">
                <div class="summary-icon neutral">
                    <i class="pi pi-clock"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-value">{{ getTotalDowntimeFormatted() }}</span>
                    <span class="summary-label">Total Downtime</span>
                </div>
            </div>
        </p-card>
    </div>

    <!-- Filters -->
    <p-card styleClass="filter-card">
        <div class="filter-row">
            <div class="filter-field">
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input
                        type="text"
                        pInputText
                        [(ngModel)]="searchText"
                        (ngModelChange)="applyFilters()"
                        placeholder="Search tickets..."
                        class="w-full">
                </span>
            </div>

            <div class="filter-field">
                <p-select
                    [(ngModel)]="selectedStatus"
                    [options]="statuses"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Status"
                    (onChange)="applyFilters()"
                    [style]="{ width: '150px' }">
                </p-select>
            </div>

            <div class="filter-field">
                <p-select
                    [(ngModel)]="selectedPriority"
                    [options]="priorities"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Priority"
                    (onChange)="applyFilters()"
                    [style]="{ width: '150px' }">
                </p-select>
            </div>

            <p-button
                label="Clear"
                icon="pi pi-filter-slash"
                [text]="true"
                (click)="clearFilters()">
            </p-button>
        </div>
    </p-card>

    <!-- Tickets Table -->
    <p-card styleClass="table-card">
        <ng-template pTemplate="header">
            <div class="card-header">
                <h2 class="card-title">Downtime Tickets</h2>
                <p-tag [value]="filteredTickets.length + ' tickets'" severity="info"></p-tag>
            </div>
        </ng-template>

        <p-table
            [value]="filteredTickets"
            [paginator]="true"
            [rows]="10"
            [rowsPerPageOptions]="[5, 10, 20, 50]"
            [rowHover]="true"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} tickets"
            styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="TicketNo">Ticket # <p-sortIcon field="TicketNo"></p-sortIcon></th>
                    <th pSortableColumn="Zone">Zone <p-sortIcon field="Zone"></p-sortIcon></th>
                    <th pSortableColumn="ImpactedProject">Project <p-sortIcon field="ImpactedProject"></p-sortIcon></th>
                    <th pSortableColumn="ImpactedMachine">Machine <p-sortIcon field="ImpactedMachine"></p-sortIcon></th>
                    <th pSortableColumn="Status">Status <p-sortIcon field="Status"></p-sortIcon></th>
                    <th pSortableColumn="Priority">Priority <p-sortIcon field="Priority"></p-sortIcon></th>
                    <th pSortableColumn="DowntimeStartsAt">Downtime Start <p-sortIcon field="DowntimeStartsAt"></p-sortIcon></th>
                    <th pSortableColumn="DowntimeDuration">Duration <p-sortIcon field="DowntimeDuration"></p-sortIcon></th>
                    <th pSortableColumn="AssignedTo">Assigned To <p-sortIcon field="AssignedTo"></p-sortIcon></th>
                    <th>Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-ticket>
                <tr [ngClass]="{'row-critical': ticket.Priority === 'Critical' && ticket.Status !== 'Closed'}">
                    <td>
                        <span class="ticket-no">{{ ticket.TicketNo }}</span>
                    </td>
                    <td>{{ ticket.Zone }}</td>
                    <td>
                        <span class="project-name">{{ ticket.ImpactedProject }}</span>
                    </td>
                    <td>{{ ticket.ImpactedMachine }}</td>
                    <td>
                        <p-tag [value]="ticket.Status" [severity]="getStatusSeverity(ticket.Status)"></p-tag>
                    </td>
                    <td>
                        <p-tag [value]="ticket.Priority" [severity]="getPrioritySeverity(ticket.Priority)"></p-tag>
                    </td>
                    <td>
                        <span class="datetime">{{ ticket.DowntimeStartsAt | date:'dd/MM/yyyy HH:mm' }}</span>
                    </td>
                    <td>
                        <span class="duration">{{ formatDuration(ticket.DowntimeDuration) }}</span>
                    </td>
                    <td>{{ ticket.AssignedTo }}</td>
                    <td>
                        <div class="action-buttons">
                            <p-button
                                icon="pi pi-eye"
                                [rounded]="true"
                                [text]="true"
                                pTooltip="View Details"
                                (click)="viewDetails(ticket)">
                            </p-button>
                            <p-button
                                icon="pi pi-pencil"
                                [rounded]="true"
                                [text]="true"
                                severity="info"
                                pTooltip="Edit Ticket"
                                (click)="openEditDialog(ticket)">
                            </p-button>
                            <p-button
                                *ngIf="ticket.Status !== 'Closed'"
                                icon="pi pi-check"
                                [rounded]="true"
                                [text]="true"
                                severity="success"
                                pTooltip="Close Ticket"
                                (click)="openCloseDialog(ticket)">
                            </p-button>
                            <p-button
                                *ngIf="ticket.Status === 'Closed' && !ticket.LeaderConfirmeClosedAt"
                                icon="pi pi-verified"
                                [rounded]="true"
                                [text]="true"
                                severity="info"
                                pTooltip="Leader Confirm"
                                (click)="confirmLeaderClose(ticket)">
                            </p-button>
                            <p-button
                                icon="pi pi-trash"
                                [rounded]="true"
                                [text]="true"
                                severity="danger"
                                pTooltip="Delete Ticket"
                                (click)="confirmDelete(ticket)">
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="10" class="text-center">
                        <div class="empty-state">
                            <i class="pi pi-inbox empty-icon"></i>
                            <p>No downtime tickets found</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>
</div>

<!-- Detail Dialog -->
<p-dialog
    header="Ticket Details"
    [(visible)]="showDetailDialog"
    [modal]="true"
    [style]="{ width: '700px' }"
    [draggable]="false"
    [resizable]="false">
    <div class="detail-content" *ngIf="selectedTicket">
        <div class="detail-header">
            <h3 class="ticket-title">{{ selectedTicket.TicketNo }}</h3>
            <p-tag [value]="selectedTicket.Status" [severity]="getStatusSeverity(selectedTicket.Status)"></p-tag>
        </div>

        <div class="detail-grid">
            <div class="detail-item">
                <label>Zone</label>
                <span>{{ selectedTicket.Zone }}</span>
            </div>
            <div class="detail-item">
                <label>Impacted Project</label>
                <span>{{ selectedTicket.ImpactedProject }}</span>
            </div>
            <div class="detail-item">
                <label>Impacted Machine</label>
                <span>{{ selectedTicket.ImpactedMachine }}</span>
            </div>
            <div class="detail-item">
                <label>Priority</label>
                <p-tag [value]="selectedTicket.Priority" [severity]="getPrioritySeverity(selectedTicket.Priority)"></p-tag>
            </div>
            <div class="detail-item">
                <label>Downtime Starts At</label>
                <span class="datetime">{{ selectedTicket.DowntimeStartsAt | date:'dd/MM/yyyy HH:mm:ss' }}</span>
            </div>
            <div class="detail-item">
                <label>Ticket Created At</label>
                <span class="datetime">{{ selectedTicket.TicketCreatedAt | date:'dd/MM/yyyy HH:mm:ss' }}</span>
            </div>
            <div class="detail-item">
                <label>Duration</label>
                <span class="duration highlight">{{ formatDuration(selectedTicket.DowntimeDuration) }}</span>
            </div>
            <div class="detail-item">
                <label>Assigned To</label>
                <span>{{ selectedTicket.AssignedTo }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedTicket.ClosedAt">
                <label>Closed At</label>
                <span class="datetime">{{ selectedTicket.ClosedAt | date:'dd/MM/yyyy HH:mm:ss' }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedTicket.LeaderConfirmeClosedAt">
                <label>Leader Confirmed At</label>
                <span class="datetime">{{ selectedTicket.LeaderConfirmeClosedAt | date:'dd/MM/yyyy HH:mm:ss' }}</span>
            </div>
        </div>

        <div class="detail-section">
            <label>Description</label>
            <p class="description">{{ selectedTicket.Description }}</p>
        </div>

        <div class="detail-section" *ngIf="selectedTicket.Resolution">
            <label>Resolution</label>
            <p class="resolution">{{ selectedTicket.Resolution }}</p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Close" icon="pi pi-times" [text]="true" (click)="showDetailDialog = false"></p-button>
    </ng-template>
</p-dialog>

<!-- Close Ticket Dialog -->
<p-dialog
    header="Close Ticket"
    [(visible)]="showCloseDialog"
    [modal]="true"
    [style]="{ width: '500px' }"
    [draggable]="false"
    [resizable]="false">
    <div class="close-dialog-content" *ngIf="selectedTicket">
        <p class="close-info">
            Closing ticket <strong>{{ selectedTicket.TicketNo }}</strong> for <strong>{{ selectedTicket.ImpactedMachine }}</strong>
        </p>
        <div class="form-field">
            <label for="resolution">Resolution *</label>
            <textarea
                id="resolution"
                pTextarea
                [(ngModel)]="resolution"
                rows="4"
                class="w-full"
                placeholder="Describe the resolution and actions taken...">
            </textarea>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" [text]="true" (click)="showCloseDialog = false"></p-button>
        <p-button label="Close Ticket" icon="pi pi-check" severity="success" (click)="closeTicket()"></p-button>
    </ng-template>
</p-dialog>

<!-- Edit Ticket Dialog -->
<p-dialog
    header="Edit Ticket"
    [(visible)]="showEditDialog"
    [modal]="true"
    [style]="{ width: '700px' }"
    [draggable]="false"
    [resizable]="false">
    <div class="edit-dialog-content" *ngIf="selectedTicket && editForm">
        <div class="edit-header">
            <p-tag [value]="selectedTicket.TicketNo" severity="info"></p-tag>
        </div>

        <div class="form-grid">
            <div class="form-field">
                <label for="editZone">Zone *</label>
                <input
                    id="editZone"
                    type="text"
                    pInputText
                    [(ngModel)]="editForm.Zone"
                    class="w-full">
            </div>

            <div class="form-field">
                <label for="editProject">Impacted Project *</label>
                <input
                    id="editProject"
                    type="text"
                    pInputText
                    [(ngModel)]="editForm.ImpactedProject"
                    class="w-full">
            </div>

            <div class="form-field">
                <label for="editMachine">Impacted Machine *</label>
                <input
                    id="editMachine"
                    type="text"
                    pInputText
                    [(ngModel)]="editForm.ImpactedMachine"
                    class="w-full">
            </div>

            <div class="form-field">
                <label for="editStatus">Status</label>
                <p-select
                    id="editStatus"
                    [(ngModel)]="editForm.Status"
                    [options]="[{label: 'Open', value: 'Open'}, {label: 'In Progress', value: 'In Progress'}, {label: 'Closed', value: 'Closed'}]"
                    optionLabel="label"
                    optionValue="value"
                    [style]="{ width: '100%' }">
                </p-select>
            </div>

            <div class="form-field">
                <label for="editPriority">Priority</label>
                <p-select
                    id="editPriority"
                    [(ngModel)]="editForm.Priority"
                    [options]="[{label: 'Low', value: 'Low'}, {label: 'Medium', value: 'Medium'}, {label: 'High', value: 'High'}, {label: 'Critical', value: 'Critical'}]"
                    optionLabel="label"
                    optionValue="value"
                    [style]="{ width: '100%' }">
                </p-select>
            </div>

            <div class="form-field">
                <label for="editDuration">Duration (minutes)</label>
                <p-inputNumber
                    id="editDuration"
                    [(ngModel)]="editForm.DowntimeDuration"
                    [min]="0"
                    suffix=" min"
                    [style]="{ width: '100%' }">
                </p-inputNumber>
            </div>

            <div class="form-field">
                <label for="editStartTime">Downtime Start</label>
                <p-datepicker
                    id="editStartTime"
                    [(ngModel)]="editForm.DowntimeStartsAt"
                    [showTime]="true"
                    [showIcon]="true"
                    dateFormat="dd/mm/yy"
                    [style]="{ width: '100%' }">
                </p-datepicker>
            </div>

            <div class="form-field">
                <label for="editAssignedTo">Assigned To</label>
                <input
                    id="editAssignedTo"
                    type="text"
                    pInputText
                    [(ngModel)]="editForm.AssignedTo"
                    class="w-full">
            </div>
        </div>

        <div class="form-field full-width">
            <label for="editDescription">Description</label>
            <textarea
                id="editDescription"
                pTextarea
                [(ngModel)]="editForm.Description"
                rows="3"
                class="w-full"
                placeholder="Describe the downtime issue...">
            </textarea>
        </div>

        <div class="form-field full-width" *ngIf="editForm.Status === 'Closed'">
            <label for="editResolution">Resolution</label>
            <textarea
                id="editResolution"
                pTextarea
                [(ngModel)]="editForm.Resolution"
                rows="3"
                class="w-full"
                placeholder="Describe the resolution...">
            </textarea>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" [text]="true" (click)="showEditDialog = false"></p-button>
        <p-button label="Save Changes" icon="pi pi-check" (click)="saveEdit()"></p-button>
    </ng-template>
</p-dialog>

<p-confirmDialog [style]="{ width: '450px' }">
    <ng-template pTemplate="message" let-message>
        <div class="confirm-message">
            <i class="pi pi-exclamation-triangle confirm-icon"></i>
            <span [innerHTML]="message.message"></span>
        </div>
    </ng-template>
</p-confirmDialog>

<p-toast position="top-right"></p-toast>
