<div class="production-workflow-container">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Production Workflow - Hourly Tracking</h1>
            <p class="page-subtitle">Manage shift setup, team assignment, and hourly production tracking</p>
        </div>
        <div class="header-time">
            <span class="current-time">{{ currentTime | date:'HH:mm:ss' }}</span>
            <span class="current-date">{{ currentTime | date:'dd/MM/yyyy' }}</span>
        </div>
    </div>

    <!-- Real-time Summary Cards -->
    <div class="summary-grid">
        <p-card styleClass="summary-card">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--blue-100);">
                    <i class="pi pi-clock" style="color: var(--blue-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Current Hour</span>
                    <span class="summary-value">H{{ getCurrentHour() }}</span>
                </div>
                <div class="summary-progress">
                    <p-progressBar [value]="hourProgress" [showValue]="false" styleClass="hour-progress"></p-progressBar>
                    <span class="progress-label">{{ hourProgress }}% completed</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--green-100);">
                    <i class="pi pi-box" style="color: var(--green-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Shift Total</span>
                    <span class="summary-value">{{ shiftTotalOutput }} / {{ shiftTotalTarget }}</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card" [ngClass]="{'card-success': shiftOverallEfficiency >= 95, 'card-warning': shiftOverallEfficiency >= 80 && shiftOverallEfficiency < 95, 'card-danger': shiftOverallEfficiency < 80}">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--purple-100);">
                    <i class="pi pi-chart-line" style="color: var(--purple-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Overall Efficiency</span>
                    <span class="summary-value">{{ shiftOverallEfficiency }}%</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="summary-card">
            <div class="summary-content">
                <div class="summary-icon" style="background-color: var(--red-100);">
                    <i class="pi pi-exclamation-triangle" style="color: var(--red-500);"></i>
                </div>
                <div class="summary-info">
                    <span class="summary-label">Total Downtime</span>
                    <span class="summary-value">{{ shiftTotalDowntime }} min</span>
                </div>
            </div>
        </p-card>
    </div>

    <!-- SHIFT SETUP -->
    <p-card styleClass="setup-card">
        <ng-template pTemplate="header">
            <div class="card-header">
                <div class="header-left">
                    <i class="pi pi-cog header-icon"></i>
                    <h2 class="card-title">Shift Setup</h2>
                    <p-tag *ngIf="session.isSetupComplete" value="✓ Complete" severity="success"></p-tag>
                    <p-tag *ngIf="!session.isSetupComplete" value="Required" severity="danger"></p-tag>
                </div>
                <div class="header-actions">
                    <p-button
                        *ngIf="session.isSetupComplete"
                        label="Edit Setup"
                        icon="pi pi-pencil"
                        [text]="true"
                        (click)="editShiftSetup()">
                    </p-button>
                </div>
            </div>
        </ng-template>

        <div *ngIf="!session.isSetupComplete">
            <form [formGroup]="shiftSetupForm" class="setup-form">
                <div class="form-grid">
                    <div class="form-field">
                        <label for="shift">Shift *</label>
                        <p-select
                            id="shift"
                            formControlName="shift"
                            [options]="shifts"
                            optionLabel="name"
                            placeholder="Select Shift"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>

                    <div class="form-field">
                        <label for="date">Date *</label>
                        <p-datepicker
                            id="date"
                            formControlName="date"
                            [showIcon]="true"
                            dateFormat="dd/mm/yy"
                            [style]="{ width: '100%' }">
                        </p-datepicker>
                    </div>

                    <div class="form-field">
                        <label for="project">Project *</label>
                        <p-select
                            id="project"
                            formControlName="project"
                            [options]="projects"
                            optionLabel="Name_Project"
                            placeholder="Select Project"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>

                    <div class="form-field">
                        <label for="productionLine">Production Line *</label>
                        <p-select
                            id="productionLine"
                            formControlName="productionLine"
                            [options]="productionLines"
                            optionLabel="name"
                            placeholder="Select Line"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>

                    <div class="form-field">
                        <label for="partNumber">Youssef *</label>
                        <p-select
                            id="partNumber"
                            formControlName="partNumber"
                            [options]="parts"
                            optionLabel="PN_Part"
                            placeholder="Select Part"
                            [style]="{ width: '100%' }">
                        </p-select>
                    </div>
                </div>

                <div class="form-actions">
                    <p-button
                        label="Complete Shift Setup"
                        icon="pi pi-check"
                        [disabled]="shiftSetupForm.invalid"
                        (click)="completeShiftSetup()">
                    </p-button>
                </div>
            </form>
        </div>

        <div *ngIf="session.isSetupComplete" class="setup-summary">
            <div class="summary-item">
                <span class="summary-label">Shift:</span>
                <span class="summary-value">{{ session.shift?.name }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Date:</span>
                <span class="summary-value">{{ session.date | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Project:</span>
                <span class="summary-value">{{ session.project?.Name_Project }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Line:</span>
                <span class="summary-value">{{ session.productionLine?.name }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Part:</span>
                <span class="summary-value">{{ session.part?.PN_Part }}</span>
            </div>
        </div>
    </p-card>

    <!-- TEAM ASSIGNMENT -->
    <p-card styleClass="team-card" *ngIf="session.isSetupComplete">
        <ng-template pTemplate="header">
            <div class="card-header">
                <div class="header-left">
                    <i class="pi pi-users header-icon"></i>
                    <h2 class="card-title">Team Assignment</h2>
                    <p-tag *ngIf="session.isTeamComplete" [value]="session.team.length + ' Assigned'" severity="success"></p-tag>
                    <p-tag *ngIf="!session.isTeamComplete" value="Assign Team" severity="warn"></p-tag>
                </div>
                <div class="header-actions">
                    <p-button
                        *ngIf="session.isTeamComplete"
                        label="Edit Team"
                        icon="pi pi-pencil"
                        [text]="true"
                        (click)="editTeamAssignment()">
                    </p-button>
                </div>
            </div>
        </ng-template>

        <div *ngIf="!session.isTeamComplete">
            <div class="team-assignment-form">
                <div class="form-row">
                    <div class="form-field flex-grow">
                        <label for="employeeScan"><i class="pi pi-id-card"></i> Scan Employee Badge</label>
                        <input
                            id="employeeScan"
                            type="text"
                            pInputText
                            [(ngModel)]="employeeIdScan"
                            placeholder="Scan employee badge"
                            class="w-full">
                    </div>

                    <div class="form-field">
                        <label for="workstation"><i class="pi pi-desktop"></i> Workstation</label>
                        <p-select
                            id="workstation"
                            [(ngModel)]="selectedWorkstation"
                            [options]="workstations"
                            optionLabel="Name_Workstation"
                            placeholder="Select Workstation"
                            [style]="{ width: '200px' }">
                        </p-select>
                    </div>

                    <div class="form-field button-field">
                        <label>&nbsp;</label>
                        <p-button
                            icon="pi pi-plus"
                            label="Add Employee"
                            (click)="addEmployee()">
                        </p-button>
                    </div>
                </div>
            </div>

            <p-divider></p-divider>

            <p-table [value]="session.team" [tableStyle]="{ 'min-width': '50rem' }">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Employee ID</th>
                        <th>Workstation</th>
                        <th>Qualification</th>
                        <th>Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-emp>
                    <tr>
                        <td>
                            <p-avatar [image]="emp.Picture" shape="circle" size="large"></p-avatar>
                        </td>
                        <td><span class="employee-name">{{ emp.Prenom_Emp }} {{ emp.Nom_Emp }}</span></td>
                        <td><span class="employee-id">{{ emp.Id_Emp }}</span></td>
                        <td>{{ emp.workstation }}</td>
                        <td>
                            <p-tag [value]="emp.qualification" [severity]="getQualificationSeverity(emp.qualificationLevel)"></p-tag>
                        </td>
                        <td>
                            <p-button icon="pi pi-trash" severity="danger" [text]="true" [rounded]="true" (click)="removeEmployee(emp)"></p-button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="empty-state">
                                <i class="pi pi-users empty-icon"></i>
                                <p class="empty-title">No employees assigned yet</p>
                                <p class="empty-subtitle">Scan employee badges to assign them to workstations</p>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>

            <p-divider></p-divider>

            <div class="actors-section">
                <h3 class="section-subtitle"><i class="pi pi-star"></i> Production Supervisors & Key Personnel</h3>
                <div class="actors-grid">
                    <div class="form-field">
                        <label for="lineLeader"><i class="pi pi-user"></i> Line Leader</label>
                        <input id="lineLeader" type="text" pInputText [(ngModel)]="session.actors.lineLeader" placeholder="Scan Line Leader badge" class="w-full">
                    </div>
                    <div class="form-field">
                        <label for="qualityAgent"><i class="pi pi-check-circle"></i> Quality Agent</label>
                        <input id="qualityAgent" type="text" pInputText [(ngModel)]="session.actors.qualityAgent" placeholder="Scan Quality Agent badge" class="w-full">
                    </div>
                    <div class="form-field">
                        <label for="maintenanceTech"><i class="pi pi-wrench"></i> Maintenance Tech</label>
                        <input id="maintenanceTech" type="text" pInputText [(ngModel)]="session.actors.maintenanceTech" placeholder="Scan Maintenance Tech badge" class="w-full">
                    </div>
                    <div class="form-field">
                        <label for="pqc"><i class="pi pi-shield"></i> PQC</label>
                        <input id="pqc" type="text" pInputText [(ngModel)]="session.actors.pqc" placeholder="Scan PQC badge" class="w-full">
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <p-button
                    label="Complete Team Assignment"
                    icon="pi pi-check"
                    [disabled]="session.team.length === 0"
                    (click)="completeTeamAssignment()">
                </p-button>
            </div>
        </div>

        <div *ngIf="session.isTeamComplete" class="team-summary">
            <div class="summary-row">
                <div class="summary-item">
                    <i class="pi pi-users summary-icon"></i>
                    <span class="summary-label">Team Members:</span>
                    <span class="summary-value">{{ session.team.length }}</span>
                </div>
                <div class="summary-item" *ngIf="session.actors.lineLeader">
                    <i class="pi pi-user summary-icon"></i>
                    <span class="summary-label">Line Leader:</span>
                    <span class="summary-value">{{ session.actors.lineLeader }}</span>
                </div>
            </div>
        </div>
    </p-card>

    <!-- HOURLY PRODUCTION TRACKER -->
    <p-card styleClass="tracker-card" *ngIf="session.isSetupComplete && session.isTeamComplete">
        <ng-template pTemplate="header">
            <div class="card-header">
                <div class="header-left">
                    <i class="pi pi-clock header-icon"></i>
                    <h2 class="card-title">Hourly Production Tracker</h2>
                    <p-tag [value]="completedHours + ' / ' + session.hours.length + ' Hours'" severity="info"></p-tag>
                </div>
                <div class="header-actions">
                    <p-button label="Reset Session" icon="pi pi-refresh" severity="secondary" [text]="true" (click)="resetSession()"></p-button>
                </div>
            </div>
        </ng-template>

        <p-table [value]="session.hours" styleClass="hourly-tracker-table" [rowHover]="true">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 80px">Hour</th>
                    <th style="width: 150px">Time Range</th>
                    <th style="width: 120px">Status</th>
                    <th style="width: 100px">Output</th>
                    <th style="width: 100px">Target</th>
                    <th style="width: 100px">Efficiency</th>
                    <th style="width: 100px">Scrap</th>
                    <th style="width: 120px">Downtime</th>
                    <th style="width: 200px">Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-hour let-i="rowIndex">
                <tr [ngClass]="{'hour-overtime': hour.isOvertime, 'hour-completed': hour.status === 'completed', 'hour-in-progress': hour.status === 'in_progress'}">
                    <td>
                        <div class="hour-number">
                            <i [class]="'pi ' + getHourStatusIcon(hour.status)"></i>
                            <strong>H{{ hour.hour }}</strong>
                        </div>
                    </td>
                    <td>
                        <span class="time-range">{{ hour.timeRange }}</span>
                    </td>
                    <td>
                        <p-tag
                            [value]="getHourStatusLabel(hour.status)"
                            [severity]="hour.status === 'completed' ? 'success' : hour.status === 'in_progress' ? 'warn' : 'secondary'">
                        </p-tag>
                    </td>
                    <td class="text-center">
                        <span class="metric-value" *ngIf="hour.output !== null">{{ hour.output }}</span>
                        <span class="metric-placeholder" *ngIf="hour.output === null">--</span>
                    </td>
                    <td class="text-center">
                        <span class="target-value">{{ hour.target }}</span>
                    </td>
                    <td class="text-center">
                        <p-tag
                            *ngIf="hour.efficiency !== null"
                            [value]="hour.efficiency + '%'"
                            [severity]="getEfficiencySeverity(hour.efficiency)">
                        </p-tag>
                        <span class="metric-placeholder" *ngIf="hour.efficiency === null">--</span>
                    </td>
                    <td class="text-center">
                        <span class="scrap-value" *ngIf="hour.scrap !== null">{{ hour.scrap }}</span>
                        <span class="metric-placeholder" *ngIf="hour.scrap === null">--</span>
                    </td>
                    <td class="text-center">
                        <div *ngIf="hour.totalDowntime > 0" class="downtime-info">
                            <i class="pi pi-exclamation-triangle downtime-icon"></i>
                            <span class="downtime-value">{{ hour.totalDowntime }} min</span>
                            <span class="downtime-count" *ngIf="hour.downtimes.length > 1">({{ hour.downtimes.length }})</span>
                        </div>
                        <span class="metric-placeholder" *ngIf="hour.totalDowntime === 0">--</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <p-button
                                *ngIf="hour.status === 'not_started' || hour.status === 'completed'"
                                [label]="hour.status === 'completed' ? 'Edit' : 'Enter'"
                                [icon]="hour.status === 'completed' ? 'pi pi-pencil' : 'pi pi-play'"
                                [severity]="hour.status === 'completed' ? 'info' : 'success'"
                                size="small"
                                (click)="openHourDialog(i)">
                            </p-button>
                            <p-button
                                *ngIf="hour.status === 'completed'"
                                icon="pi pi-clock"
                                severity="warning"
                                size="small"
                                [text]="true"
                                pTooltip="Add Downtime"
                                (click)="openDowntimeDialog(i)">
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9" class="text-center">
                        <div class="empty-state">
                            <i class="pi pi-clock empty-icon"></i>
                            <p class="empty-title">No hours configured</p>
                            <p class="empty-subtitle">Complete shift setup to generate hourly tracking</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <!-- Shift Summary Footer -->
        <div class="tracker-footer">
            <div class="footer-metrics">
                <div class="footer-metric">
                    <span class="metric-label">Shift Total:</span>
                    <span class="metric-value">{{ shiftTotalOutput }} / {{ shiftTotalTarget }}</span>
                </div>
                <div class="footer-metric">
                    <span class="metric-label">Overall Efficiency:</span>
                    <p-tag [value]="shiftOverallEfficiency + '%'" [severity]="getEfficiencySeverity(shiftOverallEfficiency)"></p-tag>
                </div>
                <div class="footer-metric">
                    <span class="metric-label">Total Scrap:</span>
                    <span class="metric-value scrap">{{ shiftTotalScrap }} pieces</span>
                </div>
                <div class="footer-metric">
                    <span class="metric-label">Total Downtime:</span>
                    <span class="metric-value downtime">{{ shiftTotalDowntime }} minutes</span>
                </div>
            </div>
        </div>
    </p-card>

    <!-- Empty State (when setup not complete) -->
    <p-card *ngIf="!session.isSetupComplete || !session.isTeamComplete" styleClass="empty-tracker-card">
        <div class="empty-state-large">
            <i class="pi pi-clock empty-icon-large"></i>
            <h3 class="empty-title-large">Start Your Shift Production Tracking</h3>
            <p class="empty-subtitle-large" *ngIf="!session.isSetupComplete">Complete shift setup above to begin tracking hourly production</p>
            <p class="empty-subtitle-large" *ngIf="session.isSetupComplete && !session.isTeamComplete">Assign your team to start tracking production</p>
        </div>
    </p-card>
</div>

<!-- HOUR PRODUCTION DIALOG -->
<p-dialog
    header="Enter Production - Hour {{ selectedHourIndex !== null ? session.hours[selectedHourIndex].hour : '' }}"
    [(visible)]="showHourDialog"
    [modal]="true"
    [style]="{ width: '600px' }"
    [draggable]="false"
    [resizable]="false">

    <div class="dialog-content" *ngIf="selectedHourIndex !== null">
        <div class="dialog-header-info">
            <div class="info-item">
                <i class="pi pi-clock"></i>
                <span>{{ session.hours[selectedHourIndex].timeRange }}</span>
            </div>
            <div class="info-item">
                <i class="pi pi-calendar"></i>
                <span>{{ session.date | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="info-item">
                <i class="pi pi-sun"></i>
                <span>{{ session.shift?.name }}</span>
            </div>
        </div>

        <p-divider></p-divider>

        <h4 class="section-title"><i class="pi pi-box"></i> Production Metrics</h4>

        <div class="metrics-input-grid">
            <div class="metric-input-card">
                <label>Output</label>
                <p-inputNumber
                    [(ngModel)]="hourProductionInput.output"
                    [showButtons]="true"
                    [min]="0"
                    inputStyleClass="large-input">
                </p-inputNumber>
                <span class="input-helper">Target: {{ session.hours[selectedHourIndex].target }}</span>
            </div>

            <div class="metric-input-card">
                <label>Scrap</label>
                <p-inputNumber
                    [(ngModel)]="hourProductionInput.scrap"
                    [showButtons]="true"
                    [min]="0"
                    inputStyleClass="large-input scrap-input">
                </p-inputNumber>
                <span class="input-helper">Target: ≤ {{ session.hours[selectedHourIndex].scrapTarget }}</span>
            </div>
        </div>

        <p-divider></p-divider>

        <h4 class="section-title"><i class="pi pi-exclamation-triangle"></i> Downtime (Optional)</h4>

        <div class="checkbox-field">
            <p-checkbox
                [(ngModel)]="hourProductionInput.hasDowntime"
                [binary]="true"
                label="This hour had downtime"
                inputId="hasDowntime">
            </p-checkbox>
        </div>

        <div *ngIf="hourProductionInput.hasDowntime" class="downtime-inputs">
            <div class="form-grid">
                <div class="form-field">
                    <label for="downtimeDuration">Duration (minutes) *</label>
                    <p-inputNumber
                        id="downtimeDuration"
                        [(ngModel)]="hourProductionInput.downtime.duration"
                        [min]="1"
                        suffix=" min"
                        [style]="{ width: '100%' }">
                    </p-inputNumber>
                </div>

                <div class="form-field">
                    <label for="downtimeProblem">Problem Category *</label>
                    <p-select
                        id="downtimeProblem"
                        [(ngModel)]="hourProductionInput.downtime.problemId"
                        [options]="downtimeProblems"
                        optionLabel="Name_DowntimeProblems"
                        optionValue="Id_DowntimeProblems"
                        placeholder="Select Problem"
                        [style]="{ width: '100%' }">
                    </p-select>
                </div>
            </div>

            <div class="form-field">
                <label for="downtimeComment">Description</label>
                <textarea
                    id="downtimeComment"
                    pTextarea
                    [(ngModel)]="hourProductionInput.downtime.comment"
                    rows="3"
                    class="w-full"
                    placeholder="Describe the downtime issue and actions taken...">
                </textarea>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button
            label="Cancel"
            icon="pi pi-times"
            [text]="true"
            (click)="closeHourDialog()">
        </p-button>
        <p-button
            label="Save Hour Production"
            icon="pi pi-check"
            (click)="saveHourProduction()">
        </p-button>
    </ng-template>
</p-dialog>

<!-- ADDITIONAL DOWNTIME DIALOG -->
<p-dialog
    header="Add Downtime Ticket"
    [(visible)]="showDowntimeDialog"
    [modal]="true"
    [style]="{ width: '500px' }"
    [draggable]="false"
    [resizable]="false">

    <div class="dialog-content" *ngIf="downtimeHourIndex !== null">
        <div class="dialog-info">
            <p><strong>Hour {{ session.hours[downtimeHourIndex].hour }}</strong> ({{ session.hours[downtimeHourIndex].timeRange }})</p>
            <p class="text-sm text-color-secondary">Add an additional downtime ticket for this hour</p>
        </div>

        <p-divider></p-divider>

        <div class="form-field">
            <label for="addDowntimeProblem">Problem Category *</label>
            <p-select
                id="addDowntimeProblem"
                [(ngModel)]="downtimeInput.Id_DowntimeProblems"
                [options]="downtimeProblems"
                optionLabel="Name_DowntimeProblems"
                optionValue="Id_DowntimeProblems"
                placeholder="Select Problem"
                [style]="{ width: '100%' }">
            </p-select>
        </div>

        <div class="form-field">
            <label for="addDowntimeDuration">Duration (minutes) *</label>
            <p-inputNumber
                id="addDowntimeDuration"
                [(ngModel)]="downtimeInput.Total_Downtime"
                [min]="1"
                suffix=" min"
                [style]="{ width: '100%' }">
            </p-inputNumber>
        </div>

        <div class="form-field">
            <label for="addDowntimeComment">Description</label>
            <textarea
                id="addDowntimeComment"
                pTextarea
                [(ngModel)]="downtimeInput.Comment_Downtime"
                rows="4"
                class="w-full"
                placeholder="Describe the downtime issue...">
            </textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button
            label="Cancel"
            icon="pi pi-times"
            [text]="true"
            (click)="closeDowntimeDialog()">
        </p-button>
        <p-button
            label="Add Downtime"
            icon="pi pi-check"
            (click)="saveAdditionalDowntime()">
        </p-button>
    </ng-template>
</p-dialog>

<p-toast position="top-right"></p-toast>
